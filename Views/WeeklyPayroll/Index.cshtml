@model IEnumerable<Employees_Attendence.Models.WeeklyPayrollRecord>
@{
    
    ViewData["Title"] = "قبض العمال الأسبوعي";
    var weekStart = (DateTime)ViewBag.WeekStart;
}

<h3 class="text-info mb-4"><i class="fa-solid fa-calendar-week me-2"></i> @ViewData["Title"]</h3>
<hr />

<div class="app-card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-secondary">الأسبوع الحالي: @weekStart.ToString("yyyy/MM/dd")</h5>
        <div>
            <a class="btn btn-sm btn-outline-secondary" asp-action="Index" asp-route-weekStart="@weekStart.AddDays(-7).ToString("yyyy-MM-dd")">
                <i class="fa-solid fa-angle-right"></i> الأسبوع الماضي
            </a>
            <a class="btn btn-sm btn-primary" asp-action="Index" asp-route-weekStart="@DateTime.Today.ToString("yyyy-MM-dd")">
                هذا الأسبوع
            </a>
            <a class="btn btn-sm btn-outline-secondary" asp-action="Index" asp-route-weekStart="@weekStart.AddDays(7).ToString("yyyy-MM-dd")">
                الأسبوع القادم <i class="fa-solid fa-angle-left"></i>
            </a>
        </div>
    </div>

    <form method="post" asp-action="SaveWeekly" id="payForm">
        <input type="hidden" name="WeekStart" value="@weekStart.ToString("yyyy-MM-dd")" />

        <table class="table table-bordered table-hover align-middle table-striped">
            <thead class="table-fancy">
                <tr>
                    <th>اسم العامل (الفئة)</th>
                    <th><i class="fa-solid fa-hammer me-1"></i> نوع العمل</th>
                    <th><i class="fa-solid fa-sack-dollar me-1"></i> الأجر اليومي الثابت</th>
                    <th><i class="fa-solid fa-calculator me-1"></i> المبلغ الأسبوعي</th>
                    <th><i class="fa-solid fa-arrow-down-wide-short me-1"></i> خصومات</th>
                    <th><i class="fa-solid fa-sack-xmark me-1"></i> واصل / استلاف</th>
                    <th><i class="fa-solid fa-money-check-dollar me-1"></i> صافي القبض</th>
                    <th>ملاحظات</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count(); i++)
                {
                    var item = Model.ElementAt(i);
                    <tr>
                        <td class="fw-bold">
                            @item.Worker?.Name <span class="badge bg-info">@item.Worker?.Category?.Name</span>
                            <input type="hidden" name="entries[@i].WorkerId" value="@item.WorkerId" />
                            <input type="hidden" name="entries[@i].WeekStart" value="@item.WeekStart.ToString("yyyy-MM-dd")" />
                            <input type="hidden" name="entries[@i].Id" value="@item.Id" />
                        </td>
                        <td>@item.Worker?.Type</td>
                        <td class="text-secondary fw-bold">@item.Worker?.DailyWage.ToString("N2")</td>

                        @* 1. Weekly Amount (مبلغ القبض) - يمكن تعديله بناءً على الحضور *@
                        <td>
                            <input type="number" step="0.01" class="form-control weeklyAmount"
                                   name="entries[@i].WeeklyAmount" value="@item.WeeklyAmount.ToString("N2")" required />
                        </td>

                        @* 2. Deductions (خصومات) *@
                        <td>
                            <input type="number" step="0.01" class="form-control deductions"
                                   name="entries[@i].Deductions" value="@item.Deductions.ToString("N2")" />
                        </td>

                        @* 3. Advances (استلاف / واصل) *@
                        <td>
                            <input type="number" step="0.01" class="form-control advances"
                                   name="entries[@i].Advances" value="@item.Advances.ToString("N2")" />
                        </td>

                        @* 4. Net Pay (صافي القبض - للقراءة فقط) *@
                        <td>
                            <input type="text" class="form-control netpay fw-bold bg-light"
                                   name="entries[@i].NetPay" value="@item.NetPay.ToString("N2")" readonly />
                        </td>

                        @* 5. Notes (ملاحظات) *@
                        <td>
                            <input type="text" class="form-control" name="entries[@i].Notes" value="@item.Notes" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light border rounded shadow-sm">
            <div>
                <strong class="text-secondary">💵 إجمالي القبض الأسبوعي الكلي: </strong>
                <span id="grandTotal" class="display-6 fw-bold text-primary">0.00</span>
            </div>
            <button class="btn btn-success btn-lg shadow" type="submit">
                <i class="fa-solid fa-floppy-disk me-1"></i> حفظ سجلات الأسبوع
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // دالة تحويل القيمة إلى رقم (معالجة الفواصل)
        function parseNum(v) { v = v + ''; v = v.replace(/,/g, ''); return parseFloat(v) || 0; }

        // دالة إعادة الحساب
        function recalc() {
            let grand = 0;
            document.querySelectorAll('tbody tr').forEach(row => {
                // استخدام querySelectorAll داخل الصف لضمان الدقة
                const weekly = parseNum(row.querySelector('.weeklyAmount')?.value);
                const ded = parseNum(row.querySelector('.deductions')?.value);
                const adv = parseNum(row.querySelector('.advances')?.value);

                // الصيغة: الصافي = المبلغ الأسبوعي - (الاستلاف + الخصومات)
                const net = weekly - (ded + adv);

                // تحديث حقل الصافي
                const netPayInput = row.querySelector('.netpay');
                if (netPayInput) netPayInput.value = net.toFixed(2);

                grand += net;
            });
            // تحديث الإجمالي الكلي في أسفل الصفحة
            document.getElementById('grandTotal').innerText = grand.toFixed(2);
        }

        // الاستماع لتغييرات الإدخال وبدء الحساب
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('weeklyAmount') || e.target.classList.contains('advances') || e.target.classList.contains('deductions')) {
                recalc();
            }
        });

        // تشغيل الدالة عند تحميل الصفحة لأول مرة (لحساب الإجمالي)
        document.addEventListener('DOMContentLoaded', recalc);
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
@model IEnumerable<Employees_Attendence.Models.MonthlyPayrollRecord>
@using Employees_Attendence.Models
@{
    ViewData["Title"] = "إنشاء سجلات القبض الشهري";
    // يتم جلب الشهر والسنة من ViewBag الذي تم إعداده في Controller
    int month = (int)ViewBag.Month;
    int year = (int)ViewBag.Year;
}

<h3 class="text-info mb-4"><i class="fa-solid fa-calendar-check me-2"></i> @ViewData["Title"]</h3>
<hr />

<div class="app-card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold text-secondary">الشهر المحدد: (@month / @year)</h5>

        @* نموذج لتغيير الشهر والسنة (لتسهيل التنقل) *@
        <form method="get" asp-action="BatchMonthly" class="d-flex align-items-center">
            <label class="me-2">الشهر:</label>
            <select name="month" class="form-select me-3" style="width:100px;">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m" selected="@(m == month ? "selected" : null)">@m</option>
                }
            </select>

            <label class="me-2">السنة:</label>
            <select name="year" class="form-select me-3" style="width:120px;">
                @for (int y = DateTime.Today.Year - 2; y <= DateTime.Today.Year + 1; y++)
                {
                    <option value="@y" selected="@(y == year ? "selected" : null)">@y</option>
                }
            </select>

            <button type="submit" class="btn btn-outline-secondary">عرض</button>
        </form>
    </div>

    @* نموذج الحفظ: يتم إرسال مصفوفة من MonthlyPayrollRecord *@
    <form method="post" asp-action="SaveMonthly" id="payForm">
        <table class="table table-bordered table-hover align-middle table-striped">
            <thead class="table-fancy">
                <tr>
                    <th>اسم العامل (الأجر اليومي)</th>
                    <th><i class="fa-solid fa-calculator me-1"></i> المبلغ الشهري المقترح</th>
                    <th><i class="fa-solid fa-arrow-down-wide-short me-1"></i> خصومات (@nameof(MonthlyPayrollRecord.Deductions))</th>
                    <th><i class="fa-solid fa-sack-xmark me-1"></i> سلف / واصل (@nameof(MonthlyPayrollRecord.Advances))</th>
                    <th><i class="fa-solid fa-money-check-dollar me-1"></i> صافي القبض (@nameof(MonthlyPayrollRecord.NetPay))</th>
                    <th>ملاحظات (أيام الحضور)</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count(); i++)
                {
                    var item = Model.ElementAt(i);
                    <tr>
                        <td class="fw-bold">
                            @item.Worker?.Name
                            <span class="badge bg-secondary">@item.Worker?.DailyWage.ToString("N2")</span>

                            @* حقول مخفية لتمرير البيانات الأساسية *@
                            <input type="hidden" name="entries[@i].WorkerId" value="@item.WorkerId" />
                            <input type="hidden" name="entries[@i].Month" value="@item.Month" />
                            <input type="hidden" name="entries[@i].Year" value="@item.Year" />
                            <input type="hidden" name="entries[@i].Id" value="@item.Id" />
                        </td>

                        @* Monthly Amount - مبلغ القبض الأساسي *@
                        <td>
                            <input type="number" step="0.01" class="form-control monthlyAmount"
                                   name="entries[@i].MonthlyAmount" value="@item.MonthlyAmount.ToString("N2")" required />
                        </td>

                        @* Deductions - الخصومات (من نموذج MonthlyPayrollRecord) *@
                        <td>
                            <input type="number" step="0.01" class="form-control deductions"
                                   name="entries[@i].Deductions" value="@item.Deductions.ToString("N2")" />
                        </td>

                        @* Advances - السلف/الواصل (من نموذج MonthlyPayrollRecord) *@
                        <td>
                            <input type="number" step="0.01" class="form-control advances"
                                   name="entries[@i].Advances" value="@item.Advances.ToString("N2")" />
                        </td>

                        @* Net Pay - الصافي (للقراءة فقط - يحسب عبر JavaScript) *@
                        <td>
                            <input type="text" class="form-control netpay fw-bold bg-light"
                                   name="entries[@i].NetPay" value="@item.NetPay.ToString("N2")" readonly />
                        </td>

                        @* Notes - الملاحظات *@
                        <td>
                            <input type="text" class="form-control" name="entries[@i].Notes" value="@item.Notes" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light border rounded shadow-sm">
            <div>
                <strong class="text-secondary">💵 إجمالي القبض الشهري الكلي: </strong>
                <span id="grandTotal" class="display-6 fw-bold text-primary">0.00</span>
            </div>
            <button class="btn btn-success btn-lg shadow" type="submit">
                <i class="fa-solid fa-floppy-disk me-1"></i> حفظ سجلات الشهر
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // دالة تحويل القيمة إلى رقم (معالجة الفواصل)
        function parseNum(v) {
            v = v + '';
            v = v.replace(/[^0-9.]/g, '');
            return parseFloat(v) || 0;
        }

        // دالة إعادة الحساب
        function recalc() {
            let grand = 0;
            document.querySelectorAll('tbody tr').forEach(row => {
                const monthly = parseNum(row.querySelector('.monthlyAmount')?.value);
                const ded = parseNum(row.querySelector('.deductions')?.value);
                const adv = parseNum(row.querySelector('.advances')?.value);

                // الصيغة: الصافي = المبلغ الشهري - (الاستلاف + الخصومات)
                const net = monthly - (ded + adv);

                // تحديث حقل الصافي
                const netPayInput = row.querySelector('.netpay');
                if (netPayInput) netPayInput.value = net.toFixed(2);

                grand += net;
            });
            // تحديث الإجمالي الكلي في أسفل الصفحة
            document.getElementById('grandTotal').innerText = grand.toFixed(2);
        }

        // الاستماع لتغييرات الإدخال وبدء الحساب
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('monthlyAmount') || e.target.classList.contains('advances') || e.target.classList.contains('deductions')) {
                recalc();
            }
        });

        // تشغيل الدالة عند تحميل الصفحة لأول مرة (لحساب الإجمالي)
        document.addEventListener('DOMContentLoaded', recalc);
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}